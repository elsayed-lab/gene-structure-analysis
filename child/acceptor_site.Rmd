```{r}
# add strand and chr information to SL site dataframe
sl_sites_combined <- merge(merge(sl_sites[['combined']], 
                                 gene_strands, by='gene'),
                           chr_mapping, by='gene')
```

### Primary acceptor sites

```{r, results='asis'}
# create a string version of chromosome sequences
chr_seqs <- lapply(fasta, as.character)

# grab a window (90nt upstream, 10nt downstream) surrounding the acceptor site
win_size_upstream = 90
win_size_downstream = 10

sl_sites_combined <- sl_sites_combined %>% 
    mutate(acc_start=ifelse(strand == '+', 
                            chr_coordinate - win_size_upstream - 1, 
                            chr_coordinate - win_size_downstream),
           acc_end=ifelse(strand=='+', 
                          chr_coordinate + win_size_downstream, 
                          chr_coordinate + win_size_upstream + 1)) %>%
    mutate(acceptor_site_win=substr(chr_seqs[chr], acc_start, acc_end))

# reverse negative strand sequences
sl_sites_combined[sl_sites_combined$strand == '-',]$acceptor_site_win <- as.character(reverseComplement(
    DNAStringSet(sl_sites_combined[sl_sites_combined$strand == '-',]$acceptor_site)
))

# actual splice acceptor site is 2nt wide
sl_sites_combined <- sl_sites_combined %>% 
    mutate(acceptor_site=substr(acceptor_site_win, win_size_upstream + 1, win_size_upstream + 2),
           acceptor_site_3nt=substr(acceptor_site_win, win_size_upstream, win_size_upstream + 2))

# exclude any sites containing N's (not very common)
sl_sites_combined <- sl_sites_combined %>% 
    filter(str_detect(acceptor_site, '[AGCT]{2}'))

# in cases where primary site was excluded, remove gene from consideration
primary_site_genes <- (sl_sites_combined %>% filter(type == 'primary'))$gene

sl_sites_combined <- sl_sites_combined[sl_sites_combined$gene %in%
                                       primary_site_genes,]

# total number of sites and number of primary sites
num_total <- nrow(sl_sites_combined)
num_primary <- nrow(sl_sites_combined %>% filter(type == 'primary'))

sl_sites_combined %>% 
    filter(type == 'primary') %>%
    select(acceptor_site) %>%
    group_by(acceptor_site) %>% 
    summarize(num=round((n() / num_primary) * 100, 2)) %>%
    arrange(desc(num)) %>%
    head %>%
    kable
```

### Alternative acceptor sites

```{r, results='asis'}
# total number of sites and number of primary sites
num_alternative <- nrow(sl_sites_combined %>% filter(type == 'alternative'))

sl_sites_combined %>% 
    filter(type == 'alternative') %>%
    select(acceptor_site) %>%
    group_by(acceptor_site) %>% 
    summarize(num=round((n() / num_alternative) * 100, 2)) %>%
    arrange(desc(num)) %>%
    head %>%
    kable
```

### Primary vs. alternative acceptor sites

```{r, figure_03a}
sl_summary <- sl_sites_combined %>% 
    select(acceptor_site, type) %>%
    group_by(type, acceptor_site) %>% 
    summarise (num=n()) %>%
    mutate(prop=num / sum(num)) %>%
    arrange(desc(prop))

ggplot(sl_summary, aes(acceptor_site, y=prop, fill=type)) +
    geom_bar(position="dodge", stat='identity')
```

### Preceeding nucleotide

```{r}
sl_sites_combined %>%
    group_by(type, acceptor_site_3nt) %>%
    summarise (num=n()) %>%
    mutate(prop=num / sum(num)) %>%
    arrange(desc(prop))
```

### Acceptor site sequence logos

#### Primary acceptor site logo

```{r figure_03e, fig.width=3840/192}
primary_seqs <- (sl_sites_combined %>% filter(type=='primary'))$acceptor_site_win

# for logo purposes, exclude sequences with N's (~1%)
primary_seqs <- primary_seqs[str_count(primary_seqs, 'N') == 0]

# convert to a PFM, and then to a PWM
pwm <- consensusMatrix(primary_seqs, as.prob=TRUE)[DNA_BASES,]

# draw sequence logo
seqLogo(pwm, ic.scale=FALSE)
```

#### Alternative acceptor site logo

```{r figure_s05, fig.width=3840/192}
alt_seqs <- (sl_sites_combined %>% filter(type=='alternative'))$acceptor_site_win

# for logo purposes, exclude sequences with N's (~1%)
alt_seqs <- alt_seqs[str_count(alt_seqs, 'N') == 0]

# convert to a PFM, and then to a PWM
pwm <- consensusMatrix(alt_seqs, as.prob=TRUE)[DNA_BASES,]

# draw sequence logo
seqLogo(pwm, ic.scale=FALSE)
```

### Distance between primary and alternative trans-splicing sites

```{r acceptor_site_dist, results='asis'}
sl_sites_combined <- sl_sites_combined %>% 
    group_by(gene) %>% 
    mutate(primary_site_dist=ifelse(strand=='+', chr_coordinate - chr_coordinate[type == 'primary'],
                                                 chr_coordinate[type == 'primary'] - chr_coordinate))

# primary - minor acceptor site distances
ag_dists <- (sl_sites_combined %>% 
             filter(type == 'alternative' & acceptor_site == 'AG'))$primary_site_dist

# ignore primary vs. primary comparisons
ag_dists <- ag_dists[ag_dists != 0]

# convert to data frame and add color based on orientation
ag_dists <- data.frame(dist=ag_dists) %>%
    mutate(orientation=ifelse(dist < 0, 'upstream', 'downstream'))

ggplot(ag_dists, aes(x=dist, fill=orientation)) + 
    geom_histogram(binwidth=20, center=10, color='white') +
    xlim(-1000, 1000)

ag_dists %>% 
    group_by(orientation) %>%
    summarize(number=n(), proportion=n() / nrow(ag_dists)) %>%
    kable
```
